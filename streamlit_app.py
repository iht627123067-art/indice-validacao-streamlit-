import streamlit as st
import pandas as pd
from datetime import datetime
import json
import os
from pathlib import Path

# Configura√ß√£o da p√°gina
st.set_page_config(
    page_title="Valida√ß√£o de Itens - √çndice de Inova√ß√£o",
    page_icon="üìä",
    layout="wide",
    initial_sidebar_state="expanded"
)

# Fun√ß√£o para carregar dados do CSV
@st.cache_data
def load_data():
    """Carrega os dados do arquivo CSV preparado"""
    try:
        # Caminho para o arquivo CSV - ajustado para Streamlit Cloud
        csv_path = Path("data/chile_iip_2025_preparado.csv")
        
        # Se n√£o encontrar no caminho local, tentar caminho relativo
        if not csv_path.exists():
            csv_path = Path("../raw_news/dados_preparados/chile_iip_2025_preparado.csv")
        
        df = pd.read_csv(csv_path)
        
        # Limpar dados
        df = df.fillna("")
        
        # Filtrar apenas itens de n√≠vel 4 (quest√µes)
        df_questoes = df[df['nivel'] == 4].copy()
        
        return df, df_questoes
    except Exception as e:
        st.error(f"Erro ao carregar dados: {e}")
        st.error(f"Tentando carregar de: {csv_path}")
        return None, None

# Fun√ß√£o para salvar valida√ß√£o localmente
def save_validation_local(validation_data):
    """Salva a valida√ß√£o em arquivo JSON local"""
    try:
        # Criar pasta para valida√ß√µes se n√£o existir
        validations_dir = Path("validations")
        validations_dir.mkdir(exist_ok=True)
        
        # Nome do arquivo baseado no usu√°rio e timestamp
        timestamp = datetime.now().strftime("%Y%m%d_%H%M%S")
        filename = f"validation_{validation_data['usuario']}_{timestamp}.json"
        filepath = validations_dir / filename
        
        # Salvar dados
        with open(filepath, 'w', encoding='utf-8') as f:
            json.dump(validation_data, f, ensure_ascii=False, indent=2)
        
        return True
    except Exception as e:
        st.error(f"Erro ao salvar valida√ß√£o: {e}")
        return False

# Fun√ß√£o para carregar valida√ß√µes existentes
def load_existing_validations():
    """Carrega valida√ß√µes existentes dos arquivos JSON"""
    try:
        validations_dir = Path("validations")
        if not validations_dir.exists():
            return pd.DataFrame()
        
        all_validations = []
        
        # Ler todos os arquivos JSON
        for json_file in validations_dir.glob("*.json"):
            try:
                with open(json_file, 'r', encoding='utf-8') as f:
                    validation = json.load(f)
                    all_validations.append(validation)
            except Exception as e:
                st.warning(f"Erro ao ler arquivo {json_file}: {e}")
        
        if all_validations:
            return pd.DataFrame(all_validations)
        else:
            return pd.DataFrame()
            
    except Exception as e:
        st.warning(f"N√£o foi poss√≠vel carregar valida√ß√µes existentes: {e}")
        return pd.DataFrame()

# Fun√ß√£o para verificar se item j√° foi validado
def check_existing_validation(validations_df, item_data):
    """Verifica se um item j√° foi validado pelo usu√°rio atual"""
    if validations_df.empty:
        return None
    
    # Filtrar por usu√°rio e dados do item
    mask = (
        (validations_df['usuario'] == st.session_state.get('usuario', '')) &
        (validations_df['sistema'] == item_data['sistema']) &
        (validations_df['ano'] == item_data['ano']) &
        (validations_df['dimensao_padrao'] == item_data['dimensao_padrao']) &
        (validations_df['subdimensao'] == item_data['subdimensao']) &
        (validations_df['questao'] == item_data['questao']) &
        (validations_df['elemento'] == item_data['elemento'])
    )
    
    existing = validations_df[mask]
    return existing.iloc[0] if not existing.empty else None

# Interface principal
def main():
    st.title("üìä Valida√ß√£o de Itens - √çndice de Inova√ß√£o P√∫blica")
    st.markdown("---")
    
    # Sidebar para configura√ß√µes
    with st.sidebar:
        st.header("‚öôÔ∏è Configura√ß√µes")
        
        # Identifica√ß√£o do usu√°rio
        usuario = st.text_input("Nome do Avaliador:", key="usuario_input")
        if usuario:
            st.session_state['usuario'] = usuario
        
        # Filtros
        st.subheader("üîç Filtros")
        
        # Carregar dados
        df, df_questoes = load_data()
        
        if df is not None:
            # Filtro por dimens√£o
            dimensoes = [''] + sorted(df_questoes['dimensao_padrao'].unique().tolist())
            dimensao_filtro = st.selectbox("Dimens√£o:", dimensoes)
            
            # Filtro por subdimens√£o
            if dimensao_filtro:
                subdimensoes = [''] + sorted(df_questoes[df_questoes['dimensao_padrao'] == dimensao_filtro]['subdimensao'].unique().tolist())
            else:
                subdimensoes = [''] + sorted(df_questoes['subdimensao'].unique().tolist())
            subdimensao_filtro = st.selectbox("Subdimens√£o:", subdimensoes)
            
            # Busca por texto
            busca = st.text_input("Buscar por texto:")
            
            # Aplicar filtros
            df_filtrado = df_questoes.copy()
            
            if dimensao_filtro:
                df_filtrado = df_filtrado[df_filtrado['dimensao_padrao'] == dimensao_filtro]
            
            if subdimensao_filtro:
                df_filtrado = df_filtrado[df_filtrado['subdimensao'] == subdimensao_filtro]
            
            if busca:
                mask = df_filtrado['texto_completo'].str.contains(busca, case=False, na=False)
                df_filtrado = df_filtrado[mask]
            
            st.info(f"üìà Total de itens: {len(df_filtrado)}")
            
            # Estat√≠sticas
            if not df_filtrado.empty:
                st.subheader("üìä Estat√≠sticas")
                st.write(f"**Dimens√µes:** {df_filtrado['dimensao_padrao'].nunique()}")
                st.write(f"**Subdimens√µes:** {df_filtrado['subdimensao'].nunique()}")
    
    # √Årea principal
    if df is None:
        st.error("‚ùå Erro ao carregar dados. Verifique se o arquivo CSV existe.")
        return
    
    if not usuario:
        st.warning("‚ö†Ô∏è Por favor, identifique-se na barra lateral para come√ßar a avalia√ß√£o.")
        return
    
    # Carregar valida√ß√µes existentes
    validations_df = load_existing_validations()
    
    # Sele√ß√£o de item para avalia√ß√£o
    st.subheader("üéØ Avalia√ß√£o de Item")
    
    if df_filtrado.empty:
        st.warning("Nenhum item encontrado com os filtros aplicados.")
        return
    
    # Selecionar item aleat√≥rio n√£o validado
    if 'current_item_index' not in st.session_state:
        st.session_state['current_item_index'] = 0
    
    # Encontrar pr√≥ximo item n√£o validado
    items_nao_validados = []
    for idx, row in df_filtrado.iterrows():
        existing = check_existing_validation(validations_df, row)
        if existing is None:
            items_nao_validados.append(idx)
    
    if not items_nao_validados:
        st.success("üéâ Todos os itens foram validados!")
        return
    
    # Selecionar item atual
    current_idx = items_nao_validados[st.session_state['current_item_index'] % len(items_nao_validados)]
    current_item = df_filtrado.loc[current_idx]
    
    # Exibir informa√ß√µes do item
    col1, col2 = st.columns([2, 1])
    
    with col1:
        st.markdown("### üìã Informa√ß√µes do Item")
        
        # Hierarquia
        st.markdown("**Hierarquia:**")
        st.write(f"**Dimens√£o:** {current_item['dimensao_padrao']}")
        st.write(f"**Subdimens√£o:** {current_item['subdimensao']}")
        st.write(f"**Quest√£o:** {current_item['questao']}")
        st.write(f"**Elemento:** {current_item['elemento']}")
        
        # Texto completo
        st.markdown("**Texto Completo:**")
        st.text_area("", value=current_item['texto_completo'], height=150, disabled=True)
    
    with col2:
        st.markdown("### ‚úÖ Avalia√ß√£o")
        
        # Status da valida√ß√£o
        status = st.selectbox(
            "Status:",
            ["", "Aprovar", "Reprovar", "Sugerir Reda√ß√£o", "Incluir Novo Item"],
            key=f"status_{current_idx}"
        )
        
        # Coment√°rio
        comentario = st.text_area(
            "Coment√°rio/Sugest√£o:",
            key=f"comentario_{current_idx}",
            height=100
        )
        
        # Novo item (se aplic√°vel)
        novo_item = False
        texto_novo_item = ""
        
        if status == "Incluir Novo Item":
            novo_item = True
            texto_novo_item = st.text_area(
                "Texto do Novo Item:",
                key=f"novo_item_{current_idx}",
                height=100
            )
        
        # Bot√µes de a√ß√£o
        col_btn1, col_btn2 = st.columns(2)
        
        with col_btn1:
            if st.button("üíæ Salvar Avalia√ß√£o", key=f"save_{current_idx}"):
                if status:
                    # Preparar dados da valida√ß√£o
                    validation_data = {
                        'timestamp': datetime.now().strftime("%Y-%m-%d %H:%M:%S"),
                        'usuario': usuario,
                        'sistema': current_item['sistema'],
                        'ano': current_item['ano'],
                        'dimensao_padrao': current_item['dimensao_padrao'],
                        'subdimensao': current_item['subdimensao'],
                        'questao': current_item['questao'],
                        'elemento': current_item['elemento'],
                        'nivel': current_item['nivel'],
                        'tipo_elemento': current_item['tipo_elemento'],
                        'texto_completo': current_item['texto_completo'],
                        'status': status,
                        'comentario': comentario,
                        'novo_item': novo_item,
                        'texto_novo_item': texto_novo_item
                    }
                    
                    # Salvar localmente
                    if save_validation_local(validation_data):
                        st.success("‚úÖ Avalia√ß√£o salva com sucesso!")
                        st.session_state['current_item_index'] += 1
                        st.rerun()
                    else:
                        st.error("‚ùå Erro ao salvar avalia√ß√£o.")
                else:
                    st.warning("‚ö†Ô∏è Selecione um status para continuar.")
        
        with col_btn2:
            if st.button("‚è≠Ô∏è Pr√≥ximo Item", key=f"next_{current_idx}"):
                st.session_state['current_item_index'] += 1
                st.rerun()
    
    # Progresso
    st.markdown("---")
    st.subheader("üìà Progresso")
    
    total_items = len(df_filtrado)
    items_validados = len(validations_df[validations_df['usuario'] == usuario]) if not validations_df.empty else 0
    
    progress = items_validados / total_items if total_items > 0 else 0
    st.progress(progress)
    st.write(f"**Progresso:** {items_validados}/{total_items} itens validados ({progress:.1%})")
    
    # Resumo das valida√ß√µes
    if not validations_df.empty:
        user_validations = validations_df[validations_df['usuario'] == usuario]
        if not user_validations.empty:
            st.subheader("üìä Resumo das Suas Valida√ß√µes")
            
            col1, col2, col3, col4 = st.columns(4)
            
            with col1:
                aprovados = len(user_validations[user_validations['status'] == 'Aprovar'])
                st.metric("‚úÖ Aprovados", aprovados)
            
            with col2:
                reprovados = len(user_validations[user_validations['status'] == 'Reprovar'])
                st.metric("‚ùå Reprovados", reprovados)
            
            with col3:
                sugestoes = len(user_validations[user_validations['status'] == 'Sugerir Reda√ß√£o'])
                st.metric("‚úèÔ∏è Sugest√µes", sugestoes)
            
            with col4:
                novos = len(user_validations[user_validations['status'] == 'Incluir Novo Item'])
                st.metric("üÜï Novos Itens", novos)

if __name__ == "__main__":
    main()
